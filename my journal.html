<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Journal with Jesus</title>
<style>
  body {
    font-family: 'Georgia', serif;
    background: #fdf6f0;
    color: #333;
    margin: 0;
    padding: 0;
  }
  header {
    background: #f7d9e3;
    padding: 2rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    color: #5a3e36;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  .journal-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
  }
  .entry {
    background: #fffdf9;
    border-radius: 12px;
    padding: 1.8rem;
    margin-bottom: 1.8rem;
    box-shadow: 0 6px 12px rgba(0,0,0,0.05);
    border-left: 6px solid #c94f6d;
    transition: transform 0.2s;
  }
  .entry:hover {
    transform: translateY(-2px);
  }
  .entry h3 {
    margin: 0 0 0.5rem;
    color: #c94f6d;
    font-size: 1.4rem;
  }
  .entry .date {
    font-size: 0.85rem;
    color: #999;
    margin-bottom: 1rem;
    font-style: italic;
  }
  .entry p {
    line-height: 1.6;
    margin: 0.4rem 0;
  }
  .entry button {
    margin-top: 0.7rem;
    margin-right: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
  }
  .edit-btn { background-color: #f7b7c9; color: #fff; }
  .edit-btn:hover { background-color: #e18aa6; }
  .save-btn { background-color: #5a3e36; color: #fff; display: none; }
  .save-btn:hover { background-color: #3d2a26; }
  .cancel-btn { background-color: #999; color: #fff; display: none; }
  .cancel-btn:hover { background-color: #777; }
  .delete-btn { background-color: #c94f6d; color: #fff; }
  .delete-btn:hover { background-color: #a43b54; }

  .download-btn {
    display: block;
    max-width: 220px;
    margin: 2rem auto;
    padding: 0.75rem 1rem;
    background: #c94f6d;
    color: #fff;
    text-align: center;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    transition: background 0.3s;
  }
  .download-btn:hover {
    background: #a43b54;
  }
  .reflection-block {
    margin-top: 0.5rem;
    padding-left: 0.5rem;
    border-left: 2px solid #f0d0dc;
    font-size: 0.95rem;
  }
</style>
</head>
<body>
<header>My Journal with Jesus</header>
<div class="journal-container" id="journalContainer">
  <!-- Entries will appear here -->
</div>
<a href="#" class="download-btn" id="downloadPDF">Download My Journal (PDF)</a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const LESSON_KEY = "jesus_journal_entries";
const journalContainer = document.getElementById('journalContainer');

function loadEntries() {
  journalContainer.innerHTML = '';
  const entries = JSON.parse(localStorage.getItem(LESSON_KEY)) || [];
  entries.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));

  entries.forEach((e, index) => {
    const entryDiv = document.createElement('div');
    entryDiv.className = 'entry';

    const reflectionsHtml = (e.reflectionAnswers && Array.isArray(e.reflectionAnswers) &&
      e.reflectionAnswers.some(ans => ans && ans.trim()))
      ? `<div class="reflection-block"><strong>Reflection Answers:</strong><br>${e.reflectionAnswers
          .map(ans => ans && ans.trim() ? ans.trim().replace(/</g,"&lt;") : '')
          .filter(Boolean)
          .join('<br><br>')}</div>`
      : '';

    entryDiv.innerHTML = `
      <h3>${e.lesson}</h3>
      <div class="date">${e.date}</div>
      <p><strong>Notes:</strong> <span class="notes-text">${e.notes ? e.notes.replace(/</g,"&lt;") : '<em>No notes yet</em>'}</span></p>
      <p><strong>Prayer:</strong> <span class="prayer-text">${e.prayer ? e.prayer.replace(/</g,"&lt;") : '<em>No prayer yet</em>'}</span></p>
      ${reflectionsHtml}
      <button class="edit-btn">Edit</button>
      <button class="save-btn">Save</button>
      <button class="cancel-btn">Cancel</button>
      <button class="delete-btn">Delete</button>
    `;

    const notesSpan = entryDiv.querySelector('.notes-text');
    const prayerSpan = entryDiv.querySelector('.prayer-text');
    const editBtn = entryDiv.querySelector('.edit-btn');
    const saveBtn = entryDiv.querySelector('.save-btn');
    const cancelBtn = entryDiv.querySelector('.cancel-btn');

    // Edit inline (notes & prayer only â€“ reflections stay as read-only summary)
    editBtn.addEventListener('click', () => {
      notesSpan.contentEditable = true;
      prayerSpan.contentEditable = true;
      notesSpan.focus();
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
    });

    // Save changes
    saveBtn.addEventListener('click', () => {
      const entriesAll = JSON.parse(localStorage.getItem(LESSON_KEY)) || [];
      const entry = entriesAll[index];
      if (entry) {
        entry.notes = notesSpan.innerText;
        entry.prayer = prayerSpan.innerText;
        entry.timestamp = new Date().toISOString();
        localStorage.setItem(LESSON_KEY, JSON.stringify(entriesAll));
      }
      notesSpan.contentEditable = false;
      prayerSpan.contentEditable = false;
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      editBtn.style.display = 'inline-block';
    });

    // Cancel edits
    cancelBtn.addEventListener('click', () => {
      const entriesAll = JSON.parse(localStorage.getItem(LESSON_KEY)) || [];
      const entry = entriesAll[index];
      if (entry) {
        notesSpan.innerText = entry.notes || '';
        prayerSpan.innerText = entry.prayer || '';
      }
      notesSpan.contentEditable = false;
      prayerSpan.contentEditable = false;
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      editBtn.style.display = 'inline-block';
    });

    // Delete entry
    entryDiv.querySelector('.delete-btn').addEventListener('click', () => {
      if(confirm("Are you sure you want to delete this entry?")) {
        const entriesAll = JSON.parse(localStorage.getItem(LESSON_KEY)) || [];
        entriesAll.splice(index,1);
        localStorage.setItem(LESSON_KEY, JSON.stringify(entriesAll));
        loadEntries();
      }
    });

    journalContainer.appendChild(entryDiv);
  });
}

loadEntries();

// PDF download
document.getElementById('downloadPDF').addEventListener('click', function(e){
  e.preventDefault();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const entries = JSON.parse(localStorage.getItem(LESSON_KEY)) || [];
  let y = 10;
  entries.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
  entries.forEach(e=>{
    doc.setFontSize(14);
    doc.text(e.lesson, 10, y);
    y += 7;
    doc.setFontSize(11);
    doc.text(`Date: ${e.date}`, 10, y);
    y += 7;
    doc.text(`Notes: ${e.notes || 'No notes yet'}`, 10, y);
    y += 7;
    doc.text(`Prayer: ${e.prayer || 'No prayer yet'}`, 10, y);
    y += 7;
    if (e.reflectionAnswers && Array.isArray(e.reflectionAnswers) &&
        e.reflectionAnswers.some(ans => ans && ans.trim())) {
      doc.text('Reflection:', 10, y);
      y += 7;
      e.reflectionAnswers.forEach(ans => {
        if (ans && ans.trim()) {
          const lines = doc.splitTextToSize(ans.trim(), 180);
          doc.text(lines, 10, y);
          y += lines.length * 6;
        }
      });
    }
    y += 10;
    if(y>280){doc.addPage(); y=10;}
  });
  doc.save('My_Journal_with_Jesus.pdf');
});
</script>
</body>
</html>
